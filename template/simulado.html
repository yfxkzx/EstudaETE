<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Simulado</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='imagens/logoETE.png') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #fafafa;
      margin: 0;
      padding-top: 70px;
    }

    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 1000;
    }

    .sair {
      font-size: 20px;
      font-weight: bold;
      text-decoration: none;
      color: #f44336;
      padding: 6px 12px;
      border-radius: 6px;
    }

    .sair:hover {
      background: #ffe5e5;
    }

    .titulo {
      font-weight: 600;
      font-size: 18px;
      color: #333;
      flex: 1;
      text-align: center;
    }

    .cronometro {
      font-size: 16px;
      font-weight: bold;
      color: #444;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .cronometro img {
      width: 24px;
      height: 24px;
    }

    .container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 40px 50px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    .questao {
      margin-bottom: 30px;
      transition: background-color 0.3s ease;
    }

    .questao img {
      display: block;
      margin: 25px auto;
      max-width: 100%;
      border-radius: 8px;
    }

    .alternativa {
      border: 2px solid #ccc;
      border-radius: 12px;
      padding: 14px 16px;
      margin: 12px 0;
      cursor: pointer;
      transition: all 0.25s ease;
      display: flex;
      align-items: center;
    }

    .alternativa:hover {
      border-color: #999;
    }

    .alternativa.correta {
      border-color: #4CAF50 !important;
      background-color: #e8f5e9;
      color: #2e7d32;
      font-weight: bold;
    }

    .alternativa.errada {
      border-color: #f44336 !important;
      background-color: #ffebee;
      color: #b71c1c;
      font-weight: bold;
    }

    .alternativa.nao-respondida {
      border-color: #ff9800 !important;
      background-color: #fff3e0;
      color: #e65100;
    }

    input[type="radio"] {
      margin-right: 10px;
    }

    .botao-finalizar {
      background: #122f5e;
      color: white;
      padding: 14px 0;
      width: 100%;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 40px;
      transition: background-color 0.3s ease;
    }

    .botao-finalizar:hover {
      background: #11285c;
    }

    .botao-finalizar.revisao {
      background: #262d69;
    }

    .botao-finalizar.revisao:hover {
      background: #181d4b;
    }

    .questao.marcada {
      background-color: transparent;
      border-left: none;
      padding-left: 0;
    }

    /* Modal de tempo esgotado */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background-color: white;
      border-radius: 12px;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
      transform: translateY(-50px);
      transition: transform 0.4s ease;
    }

    .modal-overlay.active .modal {
      transform: translateY(0);
    }

    .modal-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      display: block;
    }

    .modal h2 {
      margin: 0 0 15px 0;
      color: #333;
    }

    .modal p {
      margin: 0 0 25px 0;
      color: #666;
      line-height: 1.5;
    }

    .modal-button {
      background: #16376d;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .modal-button:hover {
      background: #3367d6;
    }

   
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .cronometro.urgente {
      color: #f44336;
      animation: pulse 1s infinite;
    }

    .cronometro.urgente img {
      animation: pulse 1s infinite;
    }
  </style>
</head>
<body>
<div class="header">
  <a href="{{ url_for('finalizar_simulado') }}" class="sair">X</a>
  <div class="titulo">Simulado</div>
  <div class="cronometro" id="cronometro">
    <img src="{{ url_for('static', filename='imagens/ampulheta.jpg') }}" alt="Ampulheta">
    <span id="tempoTexto">60:00</span>
  </div>
</div>

<div class="container">
  <form method="POST" id="simuladoForm">
    {% for q in questoes %}
      {% set idx = loop.index0 %}
      {% set correta = q.correta if q.correta is defined else null %}
      <div class="questao" data-correta="{{ correta }}" data-idx="{{ idx }}">
        <p><strong>{{ loop.index }}. {{ q.enunciado }}</strong></p>
        {% if q.imagem %}
          <img src="{{ url_for('static', filename=q.imagem.replace('static/', '')) }}" alt="Imagem">
        {% endif %}

        {% for letra, texto in q.alternativas.items() %}
          <label class="alternativa" data-letra="{{ letra }}">
            <input type="radio" name="resposta_{{ idx }}" value="{{ letra }}">
            <strong>{{ letra }})</strong>&nbsp;{{ texto }}
          </label>
        {% endfor %}
      </div>
    {% endfor %}

    <button type="button" class="botao-finalizar" id="btnFinalizar">Concluir e revisar</button>
  </form>
</div>


<div class="modal-overlay" id="modalTempoEsgotado">
  <div class="modal">
    <img src="{{ url_for('static', filename='imagens/ampulheta.jpg') }}" alt="Ampulheta" class="modal-icon">
    <h2>Tempo Esgotado!</h2>
    <p>O tempo do simulado acabou. Você pode revisar suas respostas antes de finalizar.</p>
    <button class="modal-button" id="modalOkButton">Revisar Respostas</button>
  </div>
</div>

<script>
  const cronometroEl = document.getElementById('cronometro');
  const tempoTextoEl = document.getElementById('tempoTexto');
  const modalTempoEsgotado = document.getElementById('modalTempoEsgotado');
  const modalOkButton = document.getElementById('modalOkButton');
  const simuladoForm = document.getElementById('simuladoForm');
  const btnFinalizar = document.getElementById('btnFinalizar');
  
 
  let tempoRestante = parseInt(sessionStorage.getItem('cronometroRestante') || 3600);
  let revisado = sessionStorage.getItem('revisado') === 'true';
  let tempoEsgotado = false;
  let intervalo;


  function mostrarModalTempoEsgotado() {
    tempoEsgotado = true;
    modalTempoEsgotado.classList.add('active');
    
   
    modalOkButton.onclick = function() {
      modalTempoEsgotado.classList.remove('active');
      entrarModoRevisaoTempoEsgotado();
    };
  }

  function entrarModoRevisaoTempoEsgotado() {

    marcarQuestoesNaoRespondidas();
    
   
    aplicarRevisao();
    
  
    btnFinalizar.textContent = "Finalizar";
    btnFinalizar.classList.add('revisao');
    
   
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    
    revisado = true;
    sessionStorage.setItem('revisado', 'true');
  }

   function marcarQuestoesNaoRespondidas() {
    document.querySelectorAll('.questao').forEach(questao => {
      const idx = questao.dataset.idx;
      const radios = questao.querySelectorAll('input[type="radio"]');
      let temResposta = false;
      
      
      radios.forEach(radio => {
        if (radio.checked) {
          temResposta = true;
        }
      });
      
     
      if (!temResposta) {
        questao.querySelectorAll('.alternativa').forEach(alt => {
          alt.classList.add('nao-respondida');
        });
      }
    });
  }

  
  function restaurarRespostas() {
    document.querySelectorAll('.questao').forEach(questao => {
      const idx = questao.dataset.idx;
      const respostaSalva = sessionStorage.getItem(`resposta_${idx}`);
      if (respostaSalva && respostaSalva !== 'N') {
        const radio = questao.querySelector(`input[type="radio"][value="${respostaSalva}"]`);
        if (radio) {
          radio.checked = true;
        }
      }
      
      
      questao.querySelectorAll('.alternativa').forEach(alt => {
        alt.classList.remove('correta', 'errada', 'nao-respondida');
      });
    });
  }

   function aplicarRevisao() {
    const questoes = document.querySelectorAll('.questao');

    questoes.forEach(questao => {
      const correta = questao.dataset.correta;
      const radios = questao.querySelectorAll('input[type="radio"]');
      const alternativas = questao.querySelectorAll('.alternativa');

      let respostaUsuario = null;

      radios.forEach(radio => {
        if (radio.checked) {
          respostaUsuario = radio.value;
        }
      });

      // Aplica marcações de correção
      alternativas.forEach(a => {
        const letra = a.dataset.letra;
        if (letra === correta) {
          a.classList.add('correta');
        }
        if (respostaUsuario !== null && letra === respostaUsuario && letra !== correta) {
          a.classList.add('errada');
        }
      });

      
      radios.forEach(radio => {
        radio.disabled = true;
      });
    });
  }

  
  function prepararFormularioEnvio() {
   
    document.querySelectorAll('input[type="hidden"][name^="resposta_"]').forEach(input => {
      input.remove();
    });
    
    
    document.querySelectorAll('.questao').forEach(questao => {
      const idx = questao.dataset.idx;
      const radios = questao.querySelectorAll('input[type="radio"]');
      let temResposta = false;
      
      radios.forEach(radio => {
        if (radio.checked) {
          temResposta = true;
        }
      });
      
      
      if (!temResposta) {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = `resposta_${idx}`;
        hiddenInput.value = 'N';
        simuladoForm.appendChild(hiddenInput);
      }
    });
  }

  function renderizarTempo(seg) {
    const min = String(Math.floor(seg / 60)).padStart(2, '0');
    const s = String(seg % 60).padStart(2, '0');
    tempoTextoEl.textContent = `${min}:${s}`;
    
    if (seg < 300) { 
      cronometroEl.classList.add('urgente');
    } else {
      cronometroEl.classList.remove('urgente');
    }
  }

 
  renderizarTempo(tempoRestante);
  restaurarRespostas();
  if (revisado) {
    aplicarRevisao();
    btnFinalizar.textContent = "Finalizar";
    btnFinalizar.classList.add('revisao');
  }


  function iniciarCronometro() {
    intervalo = setInterval(() => {
      tempoRestante--;
      sessionStorage.setItem('cronometroRestante', tempoRestante);
      renderizarTempo(tempoRestante);

      if (tempoRestante <= 0) {
        clearInterval(intervalo);
        sessionStorage.removeItem('cronometroRestante');
        mostrarModalTempoEsgotado();
      }
    }, 1000);
  }
  
  iniciarCronometro();


  document.querySelector('.sair').addEventListener('click', (e) => {
    clearInterval(intervalo);
    sessionStorage.removeItem('cronometroRestante');
    sessionStorage.removeItem('revisado');
    document.querySelectorAll('.questao').forEach(questao => {
      const idx = questao.dataset.idx;
      sessionStorage.removeItem(`resposta_${idx}`);
    });
  });


  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const idx = this.name.split('_')[1];
      sessionStorage.setItem(`resposta_${idx}`, this.value);
    });
  });

  btnFinalizar.addEventListener('click', function() {
    if (!revisado && !tempoEsgotado) {
      
      const totalQuestoes = document.querySelectorAll('.questao').length;
      const respostasMarcadas = document.querySelectorAll('input[type="radio"]:checked').length;
      
      if (respostasMarcadas < totalQuestoes) {
        alert(`Você precisa responder todas as questões! (Faltam ${totalQuestoes - respostasMarcadas})`);
        return;
      }


      revisado = true;
      sessionStorage.setItem('revisado', 'true');
      aplicarRevisao();
      
      this.textContent = "Finalizar";
      this.classList.add('revisao');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
    
      prepararFormularioEnvio();
      
     
      clearInterval(intervalo);
      sessionStorage.removeItem('revisado');
      sessionStorage.removeItem('cronometroRestante');
      document.querySelectorAll('.questao').forEach(questao => {
        const idx = questao.dataset.idx;
        sessionStorage.removeItem(`resposta_${idx}`);
      });
      
    
      simuladoForm.submit();
    }
  });
</script>
</body>
</html>